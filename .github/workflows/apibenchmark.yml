name: API Benchmark

on:
    workflow_dispatch:
    schedule:
        - cron: "0 0 * * *"

jobs:
    benchmark:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - uses: actions/setup-node@v4
              with:
                  node-version: "20"
            - run: node dist/main.js
              working-directory: utils/apibench
            - run: |
                  git config --global user.name 'GitHub Action'
                  git config --global user.email 'action@github.com'
                  git add data/
                  git commit -m "Update benchmark data" || exit 0
                  git push
              working-directory: utils/apibench

            - name: Check for errors and Create Summary
              id: error_check
              working-directory: utils/apibench
              run: |
                  if [ -f "data/errors.json" ]; then
                    echo "### ⚠️ API Benchmark Errors Detected" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "**Error Details:**" >> $GITHUB_STEP_SUMMARY
                    echo '```json' >> $GITHUB_STEP_SUMMARY
                    cat data/errors.json >> $GITHUB_STEP_SUMMARY
                    echo '```' >> $GITHUB_STEP_SUMMARY
                    exit 1
                  fi

            - name: Upload Error Log
              if: always() && steps.error_check.outcome == 'failure'
              uses: actions/upload-artifact@v4
              with:
                  name: api-error-log
                  path: utils/apibench/data/errors.json
